{% extends 'layout/layout.html' %}
{% load static %}
{% block body %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<div class="container py-4">

    <h4 class="mb-3 fnSuperiorRegularTitle2 text-secondary">Crear expediente</h4>

    <form method="post">
        {% csrf_token %}

        <div class="mb-4 ">
            <div class="fnSuperiorRegularTitle text-quinto ">Datos del expediente</div>
            <div class=" row  border border-3 border-quinto  rounded rounded-4">

                <div class="col-md-4 my-3">
                    <label class="form-label fnSuperiorRegularTitle3 m-0 text-primary">Socio Existente</label>
                    {{ exp_form.socio }}
                    {% if exp_form.socio.errors %}<div class="text-danger small">{{ exp_form.socio.errors }}</div>
                    {% endif %}
                </div>

                <div class="col-md-4 my-3">
                    <label class="form-label fnSuperiorRegularTitle3 m-0 text-primary">O escribir nuevo nombre</label>
                    {{ exp_form.socio_manual_nombre }}
                    {% if exp_form.socio_manual_nombre.errors %}<div class="text-danger small">{{
                        exp_form.socio_manual_nombre.errors }}</div>{% endif %}
                </div>

                <div class="col-md-4 my-3">
                    <label class="form-label fnSuperiorRegularTitle3 m-0 text-primary">Tipo de Persona (F/M)</label>
                    {{ exp_form.socio_manual_tipo }}
                    {% if exp_form.socio_manual_tipo.errors %}<div class="text-danger small">{{
                        exp_form.socio_manual_tipo.errors }}</div>{% endif %}
                </div>
     <div class="col-md-4 my-3">
                    <label class="form-label fnSuperiorRegularTitle3 m-0 text-primary">Numero Kepler</label>
                    {{ exp_form.socio_manual_numero }}
                    {% if exp_form.socio_manual_numero.errors %}<div class="text-danger small">{{
                        exp_form.socio_manual_numero.errors }}</div>{% endif %}
                </div>
                <div class="col-md-4 my-3">
                    <label class="form-label fnSuperiorRegularTitle3 m-0 text-primary">Usuario asignado</label>
                    {{ exp_form.usuario }}
                </div>
               

                <div class="col-md-4 my-3">
                    <label class="form-label fnSuperiorRegularTitle3 m-0 text-primary">Estatus</label>
                    <input type="text" class="form-control bg-grayBorder" value="Nuevo" disabled>
                </div>

            </div>
        </div>

        {% include 'Index/crearExpedienteRepObl.html' %}
        <div class="d-flex justify-content-end">
            <button class="btn btn-primary">Crear expediente</button>
        </div>

    </form>

</div>
<script>
  

    const socioSelect = document.getElementById('id_socio');
    const nombreManualInput = document.getElementById('id_socio_manual_nombre');
    const tipoManualSelect = document.getElementById('id_socio_manual_tipo');
    const tipoManualSelect = document.getElementById('id_socio_manual_numero');



    function aplicarEstiloDeshabilitado(element, deshabilitar) {
        if (deshabilitar) {
            element.classList.add('bg-grayBorder');
        } else {
            element.classList.remove('bg-grayBorder');
        }
    }

    function cargarSocio(socioId) {
        if (!socioId) {
            tipoManualSelect.value = '';
            tipoManualSelect.disabled = false;
            aplicarEstiloDeshabilitado(tipoManualSelect, false);
            nombreManualInput.disabled = false;
            aplicarEstiloDeshabilitado(nombreManualInput, false);
            return;
        }

        fetch(`/obtener-socio-data/${socioId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('No se pudo obtener el socio');
                }
                return response.json();
            })
            .then(data => {
                tipoManualSelect.value = data.tipoPersona;
                tipoManualSelect.disabled = true;
                aplicarEstiloDeshabilitado(tipoManualSelect, true);
            })
            .catch(error => console.error('Error al cargar datos del socio:', error));
    }

    function handleSocioSelectChange() {
        const selectedValue = socioSelect.value;
        if (selectedValue && selectedValue !== '') {
            nombreManualInput.value = '';
            tipoManualSelect.disabled = true;
            aplicarEstiloDeshabilitado(tipoManualSelect, true);
            nombreManualInput.disabled = true;
            aplicarEstiloDeshabilitado(nombreManualInput, true);
            cargarSocio(selectedValue);
        } else {
            tipoManualSelect.disabled = false;
            aplicarEstiloDeshabilitado(tipoManualSelect, false);
            nombreManualInput.disabled = false;
            aplicarEstiloDeshabilitado(nombreManualInput, false);
            tipoManualSelect.value = '';

  
        }
    }

    function handleManualInputChange() {
        const manualName = nombreManualInput.value.trim();
        if (manualName !== '') {
            socioSelect.value = '';
            tipoManualSelect.disabled = false;
            aplicarEstiloDeshabilitado(tipoManualSelect, false);
        }
        handleSocioSelectChange();
    }

    socioSelect.addEventListener('change', handleSocioSelectChange);
    nombreManualInput.addEventListener('input', handleManualInputChange);

    handleSocioSelectChange();
 
    render();



    document.querySelector('form').addEventListener('submit', function (e) {
        e.preventDefault();

        Swal.fire({
            title: 'Procesando...',
            text: 'Estamos creando el expediente',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading() }
        });

        const formData = new FormData(this);

        fetch(window.location.href, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Creado!',
                        text: 'El expediente se ha generado correctamente',
                        timer: 2000,
                        showConfirmButton: false
                    }).then(() => {
                        window.location.href = data.redirect_url;
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Atención',
                        html: data.error,
                        confirmButtonColor: '#3085d6'
                    });
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error de servidor',
                    text: 'No se pudo completar la solicitud.'
                });
            });
    });

 
</script>

{% endblock %}
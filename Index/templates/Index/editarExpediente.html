{% extends 'layout/layout.html' %}
{% load static %}
{% block body %}

<div class="container py-4">
    {% if expediente.eliminado == False %}
    <h2>
        #{{ expediente.pk }}
        Estatus actual:
        <span style="background-color: {{ expediente.estatus.color }};" class="rounded rounded-3 px-3 fw-bold">
            {{ expediente.estatus }}
        </span>
        <span data-bs-toggle="modal" style="cursor: pointer;" data-bs-target="#statusModal">
            <svg class="mx-2" width="25px" height="25px" viewBox="0 0 16 16" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                    <path d="M8.29289 3.70711L1 11V15H5L12.2929 7.70711L8.29289 3.70711Z" fill="#010C80"></path>
                    <path
                        d="M9.70711 2.29289L13.7071 6.29289L15.1716 4.82843C15.702 4.29799 16 3.57857 16 2.82843C16 1.26633 14.7337 0 13.1716 0C12.4214 0 11.702 0.297995 11.1716 0.828428L9.70711 2.29289Z"
                        fill="#010C80"></path>
                </g>
            </svg>
        </span>
    </h2>

    <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-tercero text-white">
                    <h5 class="modal-title" id="statusModalLabel">Cambiar status del expediente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{% url 'Index:expediente_cambiar_status' expediente.id %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <label class="form-label fw-bold">Nuevo Estatus:</label>
                        <select name="estatus" class="form-select text-black fnSuperiorRegularTitle1">
                            {% for estado in estados %}
                            <option value="{{ estado.id }}" style="background-color: {{ estado.color }};"
                                class="text-black fnSuperiorRegularTitle3" {% if estado.id == expediente.estatus_id %}selected{% endif %}>
                                {{ estado.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button type="button" class="btn btn-secondary text-white" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <h4 class="mb-3">Expediente del socio: <b>{{expediente.socio}}</b></h4>
    <h5 class="mb-3">Asignado a: <b>{{expediente.usuario}}</b>         
        <span data-bs-toggle="modal" style="cursor: pointer;" data-bs-target="#asignadoModal">
            <svg class="mx-2" width="25px" height="25px" viewBox="0 0 16 16" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <g id="SVGRepo_bgCarrier" stroke-width="0"></g>
                <g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g>
                <g id="SVGRepo_iconCarrier">
                    <path d="M8.29289 3.70711L1 11V15H5L12.2929 7.70711L8.29289 3.70711Z" fill="#010C80"></path>
                    <path
                        d="M9.70711 2.29289L13.7071 6.29289L15.1716 4.82843C15.702 4.29799 16 3.57857 16 2.82843C16 1.26633 14.7337 0 13.1716 0C12.4214 0 11.702 0.297995 11.1716 0.828428L9.70711 2.29289Z"
                        fill="#010C80"></path>
                </g>
            </svg>
        </span>
    </h5>
       <div class="modal fade" id="asignadoModal" tabindex="-1" aria-labelledby="asignadoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-tercero text-white">
                    <h5 class="modal-title" id="asignadoModalLabel">Cambiar encargado del expediente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <form method="POST" action="{% url 'Index:expediente_cambiar_usuario' expediente.id %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <label class="form-label fw-bold">Encargado:</label>
                        <select name="usuario" class="form-select text-black fnSuperiorRegularTitle1">
                            {% for usuario in usuarios %}
                            <option value="{{ usuario.id }}" class="text-black fnSuperiorRegularTitle3" {% if usuario.id == expediente.usuario_id %}selected{% endif %}>
                                {{ usuario.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>

            </div>
        </div>
    </div>
    <form method="post" novalidate id="main-edit-form">
        {% csrf_token %}

        <ul class="nav nav-tabs mb-3" id="seccionTabs" role="tablist">
            {% for item in secciones %}
            <li class="nav-item border border-primary border-2 border-right border-left border-top border-bottom-0 m-1 bg-secondary  fw-bold rounded rounded-3 rounded-top rounded-end rounded-start" role="presentation">
                <button class="nav-link {% if forloop.first %}active{% endif %} text-quinto" id="tab-{{ item.seccion.pk }} "
                    data-bs-toggle="tab" data-bs-target="#seccion-{{ item.seccion.pk }}" type="button" role="tab">
                    {{ item.seccion.tituloSeccion }} ({{ item.seccion.tipoDeSeccion }})
                </button>
            </li>
            {% endfor %}
        </ul>

        <div class="tab-content">
            {% for item in secciones %}
                    
            <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="seccion-{{ item.seccion.pk }}"
                role="tabpanel">
                    <h2>                    {{ item.seccion.tituloSeccion }} ({{ item.seccion.tipoDeSeccion }})
 </h2>
 <hr>
                <div class="card mb-3">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-striped mb-0">
                                <thead class="table-secondary">
                                    <tr>
                                        <th style="min-width:160px">Clave</th>
                                        <th>Descripción</th>
                                        <th style="min-width:140px">Fecha</th>
                                        <th style="min-width:140px">Estatus</th>
                                        <th>Comentario</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for fila in item.filas %}
                                    {% with apartado=fila.apartado registro=fila.registro %}
                                    <tr>
                                        <td class="align-middle">{{ apartado.clave }}</td>
                                        <td class="align-middle">{{ apartado.descripcion|linebreaksbr }} </td>
                                        <td>
                                            <input type="date" class="form-control form-control-sm"
                                                name="registro-{{ item.seccion.pk }}-{{ apartado.pk }}-fecha"
                                                value="{{ fila.fecha_html }}" onblur="if(!this.value) this.value='';">
                                        </td>
                                        <td>
                                            <select class="form-select form-select-sm"
                                                name="registro-{{ item.seccion.pk }}-{{ apartado.pk }}-estatus">
                                                <option value="" {% if not registro or registro.estatus == '' %}selected{% endif %}>--</option>
                                                <option value="ok" {% if registro and registro.estatus == 'ok' %}selected{% endif %}>ok</option>
                                                <option value="pendiente" {% if registro and registro.estatus == 'pendiente' %}selected{% endif %}>pendiente
                                                </option>
                                                <option value="rechazado" {% if registro and registro.estatus == 'rechazado' %}selected{% endif %}>rechazado
                                                </option>
                                                <option value="N/A" {% if registro and registro.estatus == 'N/A' %}selected{% endif %}>N/A</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input class="form-control form-control-sm" type="text"
                                                name="registro-{{ item.seccion.pk }}-{{ apartado.pk }}-comentario"
                                                value="{{ registro.comentario|default_if_none:'' }}">
                                        </td>
                                    </tr>
                                    {% endwith %}
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center py-3">No hay apartados definidos para esta
                                            sección.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    <h4> Total de registros llenados: {{totalRegistrosLlenos}} de {{totalRegistros}}</h4>

        <div class="d-flex justify-content-end">
            <a class="btn btn-error mx-2" data-bs-toggle="modal" data-bs-target="#deleteModal">Eliminar Expediente</a>
            <a class="btn btn-secondary mx-2 text-white" href="{% url 'Index:exportarPDF' expediente.id %}">Exportar a PDF</a>
<a class="btn btn-green mx-2 text-white" href="{% url 'Index:exportarExcel' expediente.id %}" target="_blank">Exportar a Excel</a>           <a class="btn btn-cuarto mx-2 text-white" href="{% url 'Index:expediente_llenar' expediente.id %}">Llenar valores vacios</a>

            <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered ">
                    <div class="modal-content">
                        <div class="modal-header bg-tercero text-white">
                            <h5 class="modal-title" id="deleteModalLabel">Confirmar cierre de sesión</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body text-center">
                            ¿Estás seguro de que deseas borrar el expediente #{{ expediente.pk }} ?
                        </div>
                        <div class="modal-footer justify-content-center">
                            <button type="button" class="btn btn-tercero text-white"
                                data-bs-dismiss="modal">Cancelar</button>
                            <a href="{% url 'Index:expediente_eliminar' expediente.id %}"
                                class="btn btn-primary">Eliminar Expediente</a>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary ms-2" type="submit" id="save-button">Guardar</button>
        </div>

    </form>
    {% else %}
    <div class="row">
        <div class="col-12 text-center fnSuperiorRegularTitle">
            Parece que el contenido que buscas ya no esta disponible, contacta a un administrador para más información
        </div>
        <div class="col-12 text-center">
            <img src="{% static 'img/404.png' %}" style="width: max-content; height: auto;" alt="">
        </div>
    </div>
    {% endif %}
</div>

<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="successModalLabel">Operación Exitosa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <p class="h4">Datos guardados con éxito.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="loadingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3 h5">Guardando, espera un momento...</p>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. Uso de Django para definir una variable JS
    let dataSavedSuccessfully = false;

    {% if messages %}
    {% for message in messages %}
    {% if 'success' in message.tags %}
    dataSavedSuccessfully = true;
    {% endif %}
    {% endfor %}
    {% endif %}

    // 2. Lógica JavaScript pura (al cargar la página)
    document.addEventListener('DOMContentLoaded', function () {
        const mainForm = document.getElementById('main-edit-form');
        const loadingModalElement = document.getElementById('loadingModal');

        // Función para mostrar el modal de carga: "Guardando, espera un momento..."
        if (mainForm) {
            mainForm.addEventListener('submit', function (event) {
                const loadingModal = new bootstrap.Modal(loadingModalElement, {
                    backdrop: 'static',
                    keyboard: false
                });
                loadingModal.show();
            });
        }

        // 3. Mostrar el modal de éxito si la variable JS es true (solo tras la recarga por el redirect)
        if (dataSavedSuccessfully) {
            // Oculta el modal de carga si por alguna razón sigue visible
            const loadingModalInstance = bootstrap.Modal.getInstance(loadingModalElement);
            if (loadingModalInstance) {
                loadingModalInstance.hide();
            }

            // Muestra el modal de éxito: "Datos guardados con éxito"
            const successModal = new bootstrap.Modal(document.getElementById('successModal'));
            successModal.show();
        }
    });
</script>

{% endblock %}
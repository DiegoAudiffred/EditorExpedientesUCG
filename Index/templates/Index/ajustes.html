{% extends 'layout/layout.html' %}
{% load static %}
{% block body %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css" />
<script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.es5.min.js"></script>

<style>
    .pickr .pcr-button {
        height: 2.5em;
        width: 2.5em;
        margin-top: 0.5em;
    }

    .pcr-button {
        border: 4px solid var(--bs-primary, #0d6efd) !important;
        border-radius: 50%;
    }

    .form-check-input.form-check-lg {
        height: 2.5em;
        width: 2.5em;
        margin-top: 0.25em;
    }
</style>

<div class="container my-5">
    <h1 class="fnSuperiorRegularTitle2 text-secondary "> Modificar estados</h1>
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} fnSuperiorRegularTitle">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    <form method="post">
        <input type="hidden" name="form_name" value="estado_form"> {{ formset.management_form }}
        {% csrf_token %}


        <div class="row mb-3">

            {% if formset.non_field_errors %}
            <div class="alert alert-danger w-100">
                {% for error in formset.non_field_errors %}{{ error }}{% endfor %}
            </div>
            {% endif %}

            <div class="col-md-7 col-2 fnSuperiorRegularTitle3 d-none d-md-block"><label>Nombre</label></div>
            <div class="col-md-3 col-2 fnSuperiorRegularTitle3 d-none d-md-block"><label>Color</label></div>
            <div class="col-md-2 col-2 fnSuperiorRegularTitle3 d-none d-md-block text-center"><label>Picker</label>
            </div>
            <div class="col-6"></div>

            {% for form in formset %}

            <div class="col-md-7 col-12 text-center ">
                <div class="fnSuperiorRegularTitle2">{{ form.nombre }}</div>
                {% if form.nombre.errors %}<div class="text-danger small">{{ form.nombre.errors }}</div>{% endif %}
            </div>

            <div class="col-md-3 col-10 text-center">
                <div class="d-flex align-items-center">
                    {{ form.color }}

                    {% if form.color.errors %}<div class="text-danger small">{{ form.color.errors }}</div>{% endif %}
                </div>
            </div>

            <div class="col-md-2 col-2 text-center">
                <div class="color-picker-anchor " data-input-id="{{ form.color.id_for_label }}"></div>
            </div>

            {{ form.id }}

            {% endfor %}
        </div>
        <button type="submit" class="btn btn-primary col-12 my-2">Guardar Estados</button>
    </form>
</div>

<div class="container my-5">
    <h1 class="fnSuperiorRegularTitle2 text-secondary "> Modificar Socio</h1>

    <form method="post" id="form-editar-socio">
        {% csrf_token %}
        <input type="hidden" name="form_name" value="socio_form"> <input type="hidden" name="socio_id"
            id="socio-id-input" value="">

        <div class="mb-3">
            <label class="fnSuperiorRegularTitle3" for="{{ formSocios.socio_selector.id_for_label }}">Socio a
                Editar</label>
            {{ formSocios.socio_selector }}
        </div>

        <div class="mb-3">
            <label class="fnSuperiorRegularTitle3" for="{{ formSocios.nombre.id_for_label }}">Nombre</label>
            {{ formSocios.nombre }}
            {% if formSocios.nombre.errors %}<div class="text-danger small">{{ formSocios.nombre.errors }}</div>
            {% endif %}
        </div>

        <div class="mb-3">
            <label class="fnSuperiorRegularTitle3" for="{{ formSocios.tipoPersona.id_for_label }}">Tipo de
                Persona</label>
            {{ formSocios.tipoPersona }}
            {% if formSocios.tipoPersona.errors %}<div class="text-danger small">{{ formSocios.tipoPersona.errors }}
            </div>{% endif %}
        </div>

        <button type="submit" class="btn btn-primary col-12 my-2">Guardar Socio</button>
    </form>
</div>

<div class="container my-5">
    <h1 class="fnSuperiorRegularTitle2 text-secondary "> Modificar Apartado de Catálogo</h1>

    <form method="post" id="form-editar-apartado">
        {% csrf_token %}
        <input type="hidden" name="form_name" value="apartado_form"> 
        <input type="hidden" name="apartado_id" id="apartado-id-input" value="">

        <div class="mb-3">
            <label class="fnSuperiorRegularTitle3" for="{{ formSelectorApartado.apartado_selector.id_for_label }}">Apartado a
                Editar/Crear</label>
            {{ formSelectorApartado.apartado_selector }}
        </div>
        
        <div class="mb-3">
            <label class="fnSuperiorRegularTitle3" for="{{ formApartado.tipoDeSeccion.id_for_label }}">Tipo de Sección</label>
            {{ formApartado.tipoDeSeccion }}
            {% if formApartado.tipoDeSeccion.errors %}<div class="text-danger small">{{ formApartado.tipoDeSeccion.errors }}</div>{% endif %}
        </div>

        <div class="mb-3">
            <label class="fnSuperiorRegularTitle3" for="{{ formApartado.clave.id_for_label }}">Clave</label>
            {{ formApartado.clave }}
            {% if formApartado.clave.errors %}<div class="text-danger small">{{ formApartado.clave.errors }}</div>{% endif %}
        </div>

        <div class="mb-3">
            <label class="fnSuperiorRegularTitle3" for="{{ formApartado.descripcion.id_for_label }}">Descripción</label>
            {{ formApartado.descripcion }}
            {% if formApartado.descripcion.errors %}<div class="text-danger small">{{ formApartado.descripcion.errors }}</div>{% endif %}
        </div>
        
        <div class="mb-3">
            <label class="fnSuperiorRegularTitle3" for="{{ formApartado.areaDondeAplica.id_for_label }}">Área Donde Aplica</label>
            {{ formApartado.areaDondeAplica }}
            {% if formApartado.areaDondeAplica.errors %}<div class="text-danger small">{{ formApartado.areaDondeAplica.errors }}</div>{% endif %}
        </div>

        <button type="submit" class="btn btn-primary col-12 my-2">Guardar Apartado</button>
    </form>
</div>

<script>
    function cargarSocio(socioId) {
        const nombreInput = document.getElementById('{{ formSocios.nombre.id_for_label }}');
        const tipoPersonaSelect = document.getElementById('{{ formSocios.tipoPersona.id_for_label }}');
        const socioIdInput = document.getElementById('socio-id-input');

        socioIdInput.value = socioId;

        if (!socioId) {
            nombreInput.value = '';
            tipoPersonaSelect.value = '';
            return;
        }

        fetch(`/obtener-socio-data/${socioId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('No se pudo obtener el socio');
                }
                return response.json();
            })
            .then(data => {
                nombreInput.value = data.nombre;
                tipoPersonaSelect.value = data.tipoPersona;
            })
            .catch(error => console.error('Error al cargar datos del socio:', error));
    }
    
    function cargarApartado(apartadoId) {
        const tipoDeSeccionSelect = document.getElementById('{{ formApartado.tipoDeSeccion.id_for_label }}');
        const claveInput = document.getElementById('{{ formApartado.clave.id_for_label }}');
        const descripcionInput = document.getElementById('{{ formApartado.descripcion.id_for_label }}');
        const areaDondeAplicaSelect = document.getElementById('{{ formApartado.areaDondeAplica.id_for_label }}');
        const apartadoIdInput = document.getElementById('apartado-id-input');

        apartadoIdInput.value = apartadoId;

        if (!apartadoId) {
            tipoDeSeccionSelect.value = tipoDeSeccionSelect.options.length > 0 ? tipoDeSeccionSelect.options[0].value : ''; 
            claveInput.value = '';
            descripcionInput.value = '';
            areaDondeAplicaSelect.value = areaDondeAplicaSelect.options.length > 0 ? areaDondeAplicaSelect.options[0].value : ''; 
            return;
        }

        fetch(`/obtener-apartado-data/${apartadoId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('No se pudo obtener el apartado');
                }
                return response.json();
            })
            .then(data => {
                tipoDeSeccionSelect.value = data.tipoDeSeccion;
                claveInput.value = data.clave;
                descripcionInput.value = data.descripcion;
                areaDondeAplicaSelect.value = data.areaDondeAplica;
            })
            .catch(error => console.error('Error al cargar datos del apartado:', error));
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const anchors = document.querySelectorAll('.color-picker-anchor');

        anchors.forEach(anchor => {
            const inputId = anchor.dataset.inputId;
            const inputField = document.getElementById(inputId);

            const picker = Pickr.create({
                el: anchor,
                theme: 'classic',
                default: inputField.value || '#000000',
                components: {
                    preview: true,
                    hue: true,
                    interaction: {
                        hex: true,
                        input: true,
                        clear: false,
                        save: true
                    }
                }
            });

            inputField.classList.add('border', 'border-3', 'border-primary', 'my-2', 'rounded', 'rounded-5');
            inputField.style.backgroundColor = inputField.value;

            picker.on('change', (color) => {
                const hexColor = color.toHEXA().toString();
                inputField.value = hexColor;
                inputField.style.backgroundColor = hexColor;
            }).on('save', (color) => {
                const hexColor = color.toHEXA().toString();
                inputField.value = hexColor;
                inputField.style.backgroundColor = hexColor;
                picker.hide();
            });
        });
        
        const apartadoSelector = document.getElementById('id_apartado_selector');
        if (apartadoSelector) {
            cargarApartado(apartadoSelector.value);
            apartadoSelector.addEventListener('change', (e) => cargarApartado(e.target.value));
        }
        
        const socioSelector = document.getElementById('id_socio_selector');
        if (socioSelector) {
            cargarSocio(socioSelector.value);
            socioSelector.addEventListener('change', (e) => cargarSocio(e.target.value));
        }
    });
</script>
{% endblock %}